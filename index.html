<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa Vizinhança Viva - Bairros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #container {
      position: relative;
      height: 100%;
      width: 100%;
    }
    #map {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #painel {
      position: absolute;
      top: 0;
      right: 0;
      width: 340px;
      height: 100%;
      background: #1e1e1e;
      color: #fff;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 2;
    }
    #painel.aberto {
      transform: translateX(0%);
    }
    .map-label {
      position: absolute;
      background-color: transparent;
      color: #ffffff;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      pointer-events: none;
      transform: translate(-50%, -50%);
      text-shadow: 0 0 3px #000;
    }
    form label {
      display: block;
      margin-top: 10px;
    }
    form input[type="number"],
    form textarea,
    form select {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
      background: #333;
      border: none;
      color: #fff;
    }
    form button {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      background: #4caf50;
      border: none;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap" async defer></script>
</head>
<body>
  <div id="container">
    <div id="map"></div>
    <div id="painel">
      <h2 id="nome-bairro">Selecione um bairro</h2>
      <p id="descricao-bairro">Descrição do bairro aqui.</p>
      <p><strong>Segurança:</strong> <span id="seguranca"></span> ⭐</p>
      <p><strong>Ruído:</strong> <span id="ruido"></span> ⭐</p>
      <p><strong>Limpeza:</strong> <span id="limpeza"></span> ⭐</p>
      <p><strong>Tranquilidade:</strong> <span id="tranquilidade"></span> ⭐</p>
      <p><strong>Ideal para crianças:</strong> <span id="criancas"></span> ⭐</p>
      <p><strong>Ótimos vizinhos:</strong> <span id="vizinhos"></span> ⭐</p>
      <p><strong>Média geral:</strong> <span id="media-geral"></span> ⭐</p>
      <h3>Comentários</h3>
      <ul id="comentarios"></ul>
      <h3>Avalie este bairro</h3>
      <form id="form-avaliacao">
        <label>Morador / Visitante</label>
        <select name="tipo">
          <option value="morador">Morador</option>
          <option value="visitante">Visitante</option>
        </select>
        <label>Segurança</label>
        <input type="number" name="seguranca" min="1" max="5">
        <label>Ruído</label>
        <input type="number" name="ruido" min="1" max="5">
        <label>Limpeza</label>
        <input type="number" name="limpeza" min="1" max="5">
        <label>Tranquilidade</label>
        <input type="number" name="tranquilidade" min="1" max="5">
        <label>Ideal para crianças</label>
        <input type="number" name="ideal-criancas" min="1" max="5">
        <label>Ótimos vizinhos</label>
        <input type="number" name="otimos-vizinhos" min="1" max="5">
        <label>Deixe seu comentário</label>
        <textarea name="comentario" rows="3"></textarea>
        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzzKVt7XWu-Q8ZcpKbE7kAIJ4pRjwkv9t2_c56zQKgQseD-I9qKzbtAAoDjJ0yvQx6EmA/exec';
    const BAIRROS_URL = WEBHOOK_URL + '?action=read';

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ffffff';
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        return JSON.parse(JSON.parse(text));
      }
    }

    let map;
    window.initMap = function () {
      const fallbackCenter = { lat: -19.82, lng: -40.27 };
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => criarMapa({ lat: pos.coords.latitude, lng: pos.coords.longitude }, 15),
          () => criarMapa(fallbackCenter, 12)
        );
      } else {
        criarMapa(fallbackCenter, 12);
      }
    }

    function criarMapa(center, zoom) {
      map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom,
        streetViewControl: false,
        mapTypeControl: false,
        gestureHandling: 'greedy',
        styles: [
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
          { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#2c2c2c" }] },
          { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }] }
        ]
      });

      map.addListener('click', () => {
        document.getElementById("painel").classList.remove("aberto");
      });

      carregarBairros();
    }

    async function carregarBairros() {
      const bairros = await fetchJson(BAIRROS_URL);
      bairros.forEach(b => {
        const coordsText = b.Poligono || '';
        if (!coordsText) return;

        const coordPairs = coordsText.split(';').map(p => {
          const [lat, lng] = p.trim().split(',').map(Number);
          return { lat, lng };
        }).filter(p => !isNaN(p.lat) && !isNaN(p.lng));

        if (coordPairs.length < 3) return;

        const reputacao = parseFloat(b.ReputacaoComp);
        const cor = getCorByReputacao(reputacao);

        const poligono = new google.maps.Polygon({
          paths: coordPairs,
          strokeColor: cor,
          strokeOpacity: 1,
          strokeWeight: 2,
          fillColor: cor,
          fillOpacity: isNaN(reputacao) ? 0 : 0.2,
          map: map
        });

        const centro = calcularCentroide(coordPairs);
        const texto = `${b.Nome} (${isNaN(reputacao) ? '0.0' : reputacao.toFixed(1)}⭐)`;
        const div = document.createElement('div');
        div.className = 'map-label';
        div.textContent = texto;

        const label = new google.maps.OverlayView();
        label.onAdd = function () {
          this.getPanes().overlayLayer.appendChild(div);
        };
        label.draw = function () {
          const proj = this.getProjection();
          const pos = proj.fromLatLngToDivPixel(new google.maps.LatLng(centro.lat, centro.lng));
          div.style.left = pos.x + 'px';
          div.style.top = pos.y + 'px';
        };
        label.setMap(map);

        poligono.addListener('click', (event) => {
          event.stop();
          const painel = document.getElementById("painel");
          painel.classList.add("aberto");

          document.getElementById("nome-bairro").innerText = b.Nome;
          document.getElementById("descricao-bairro").innerText = b.Resumo_IA || "Sem descrição";
          document.getElementById("seguranca").innerText = b.Segurança || '0';
          document.getElementById("ruido").innerText = b.Ruído || '0';
          document.getElementById("limpeza").innerText = b.Limpeza || '0';
          document.getElementById("tranquilidade").innerText = b.Tranquilidade || '0';
          document.getElementById("criancas").innerText = b["Ideal para crianças"] || '0';
          document.getElementById("vizinhos").innerText = b["Ótimos vizinhos"] || '0';
          document.getElementById("media-geral").innerText = isNaN(reputacao) ? '0.0' : reputacao.toFixed(1);

          const lista = document.getElementById("comentarios");
          lista.innerHTML = '';
          (b.Comentarios || '').split('|').forEach(c => {
            const li = document.createElement('li');
            li.textContent = c;
            lista.appendChild(li);
          });
        });
      });
    }

    function calcularCentroide(pontos) {
      let lat = 0, lng = 0;
      pontos.forEach(p => {
        lat += p.lat;
        lng += p.lng;
      });
      return { lat: lat / pontos.length, lng: lng / pontos.length };
    }

    document.getElementById("form-avaliacao").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;
      const bairro = document.getElementById("nome-bairro").innerText;

      const payload = {
        bairro,
        tipo: form.tipo.value,
        seguranca: parseInt(form.seguranca.value) || 0,
        ruido: parseInt(form.ruido.value) || 0,
        limpeza: parseInt(form.limpeza.value) || 0,
        tranquilidade: parseInt(form.tranquilidade.value) || 0,
        idealCriancas: parseInt(form["ideal-criancas"].value) || 0,
        otimosVizinhos: parseInt(form["otimos-vizinhos"].value) || 0,
        comentario: form.comentario.value.trim()
      };

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        });

        const json = await res.json();
        if (json.success) {
          alert("Avaliação enviada com sucesso!");
          form.reset();
        } else {
          alert("Erro ao enviar avaliação.");
        }
      } catch (err) {
        alert("Erro de rede.");
        console.error(err);
      }
    });
  </script>
</body>
</html>


