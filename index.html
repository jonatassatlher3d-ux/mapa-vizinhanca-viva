<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Vizinhança Viva</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    #sidebar {
      width: 300px;
      height: 100%;
      background-color: #1e1e1e;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      position: absolute;
      right: 0;
      top: 0;
      display: none;
      z-index: 1;
    }

    .categoria {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .estrela {
      color: gold;
      margin-left: 5px;
    }

    .rating {
      display: flex;
      cursor: pointer;
    }

    .rating span {
      font-size: 20px;
      color: gray;
    }

    .rating span.active {
      color: gold;
    }

    label, textarea, button {
      display: block;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      padding: 5px;
      border: none;
      border-radius: 4px;
    }

    button {
      background-color: #28a745;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    #toast {
      visibility: hidden;
      min-width: 100px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 5px;
      padding: 10px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
    }

    #toast.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2s;
    }

    @keyframes fadein {
      from { bottom: 0; opacity: 0; }
      to { bottom: 30px; opacity: 1; }
    }

    @keyframes fadeout {
      from { bottom: 30px; opacity: 1; }
      to { bottom: 0; opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="sidebar">
    <h2 id="bairro-titulo">Bairro Selecionado</h2>
    <div id="bairro-descricao" style="margin-bottom:10px;">Clique em um bairro</div>
    <div id="bairro-medias"></div>

    <form id="form-avaliacao" style="display: none;">
      <label>Segurança</label>
      <div class="rating" data-field="Seguranca"></div>

      <label>Ruído</label>
      <div class="rating" data-field="Ruido"></div>

      <label>Limpeza</label>
      <div class="rating" data-field="Limpeza"></div>

      <label>Tranquilidade</label>
      <div class="rating" data-field="Tranquilidade"></div>

      <label>Ideal para crianças?</label>
      <select name="IdealCriancas" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label>Ótimos vizinhos?</label>
      <select name="OtimosVizinhos" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label>Comentário</label>
      <textarea name="Comentario" rows="3"></textarea>

      <button type="submit" id="btn-enviar">Enviar Avaliação</button>
    </form>
  </div>

  <div id="toast">Enviado!</div>

  <script>
    let map;
    let bairroSelecionado = "";
    let ratings = {};

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ffffff';
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    const estilosDark = [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "poi.business", stylers: [{ visibility: "off" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
      { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
      { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
      { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
    ];

    function criarEstrelas(container, field) {
      container.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const span = document.createElement("span");
        span.innerHTML = "★";
        span.addEventListener("click", () => {
          ratings[field] = i;
          Array.from(container.children).forEach((s, idx) => {
            s.classList.toggle("active", idx < i);
          });
        });
        container.appendChild(span);
      }
    }

    function initMap() {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLocation = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        map = new google.maps.Map(document.getElementById("map"), {
          center: userLocation,
          zoom: 15,
          styles: estilosDark
        });

        map.addListener("click", () => {
          document.getElementById("sidebar").style.display = "none";
          document.getElementById("map").style.width = "100%";
        });

        const url = "https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec?action=getBairros";

        fetch(url)
          .then(resp => resp.json())
          .then(data => {
            data.forEach(bairro => {
              if (bairro.Poligono) {
                const path = bairro.Poligono.split(";").map(p => {
                  const [lat, lng] = p.trim().split(",").map(Number);
                  return { lat, lng };
                });

                const cor = getCorByReputacao(parseFloat(bairro.ReputacaoComp));
                const polygon = new google.maps.Polygon({
                  paths: path,
                  strokeColor: cor,
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: cor,
                  fillOpacity: 0.35,
                });

                polygon.setMap(map);

                polygon.addListener("click", () => {
                  bairroSelecionado = bairro.Nome;
                  document.getElementById("bairro-titulo").innerText =
                    `${bairro.Nome} (${bairro.ReputacaoComp}⭐)`;
                  document.getElementById("bairro-descricao").innerText =
                    bairro.Resumo_IA || "Sem descrição disponível.";

                  // Exibir médias (exceto reputação)
                  const mediasDiv = document.getElementById("bairro-medias");
                  mediasDiv.innerHTML = "";
                  ["Seguranca", "Ruido", "Limpeza", "Tranquilidade"].forEach(cat => {
                    if (bairro[cat]) {
                      mediasDiv.innerHTML += `<div class="categoria">${cat}: ${bairro[cat]}<span class="estrela">★</span></div>`;
                    }
                  });

                  document.getElementById("sidebar").style.display = "block";
                  document.getElementById("form-avaliacao").style.display = "block";
                  document.getElementById("map").style.width = "calc(100% - 300px)";
                });
              }
            });
          });

        // Inicializa estrelas do formulário
        document.querySelectorAll(".rating").forEach(r => {
          criarEstrelas(r, r.dataset.field);
        });

      }, () => {
        alert("Não foi possível obter sua localização.");
      });
    }

    document.getElementById("form-avaliacao").addEventListener("submit", function (e) {
      e.preventDefault();
      const btn = document.getElementById("btn-enviar");
      btn.disabled = true;
      btn.innerText = "Enviando...";

      const formData = new FormData(this);
      const data = {
        Bairro: bairroSelecionado,
        Seguranca: ratings.Seguranca || 0,
        Ruido: ratings.Ruido || 0,
        Limpeza: ratings.Limpeza || 0,
        Tranquilidade: ratings.Tranquilidade || 0,
        IdealCriancas: formData.get("IdealCriancas"),
        OtimosVizinhos: formData.get("OtimosVizinhos"),
        Comentario: formData.get("Comentario")
      };

      fetch("https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec", {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(resp => resp.json())
      .then(() => {
        const toast = document.getElementById("toast");
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2500);
        this.reset();
        ratings = {};
        document.querySelectorAll(".rating").forEach(r => criarEstrelas(r, r.dataset.field));
      })
      .catch(err => console.error(err))
      .finally(() => {
        btn.disabled = false;
        btn.innerText = "Enviar Avaliação";
      });
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap">
  </script>
</body>
</html>
