<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa Vizinhança Viva - Bairros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .map-label {
      position: absolute;
      background-color: transparent;
      color: #ffffff;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap" async defer></script>
</head>
<body>
  <div id="map"></div>

  <script>
    const BAIRROS_URL = 'https://script.google.com/macros/s/AKfycbwa8dX3rPfxyD83ow_11KtHewoKk5N1a25pHxYHh_hj8QSgSTzl8zXJSasy-Hr_GWDf0A/exec?sheet=Bairros';

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ff0000';
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return JSON.parse(JSON.parse(text));
      }
    }

    let map;

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const center = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            criarMapa(center, 20);
          },
          () => {
            iniciarComCentroPadrao();
          }
        );
      } else {
        iniciarComCentroPadrao();
      }
    }

    function iniciarComCentroPadrao() {
      const center = { lat: -19.82, lng: -40.27 };
      criarMapa(center, 12);
    }

    function criarMapa(center, zoom) {
      map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom,
        streetViewControl: false,
        mapTypeControl: false,
        styles: [
          { "elementType": "geometry", "stylers": [{ "color": "#212121" }] },
          { "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] },
          { "elementType": "labels.text.fill", "stylers": [{ "color": "#757575" }] },
          { "elementType": "labels.text.stroke", "stylers": [{ "color": "#212121" }] },
          { "featureType": "administrative", "elementType": "geometry", "stylers": [{ "color": "#757575" }] },
          { "featureType": "administrative.country", "elementType": "labels.text.fill", "stylers": [{ "color": "#9e9e9e" }] },
          { "featureType": "administrative.locality", "elementType": "labels.text.fill", "stylers": [{ "color": "#bdbdbd" }] },
          { "featureType": "poi", "elementType": "labels.text.fill", "stylers": [{ "color": "#757575" }] },
          { "featureType": "poi.park", "elementType": "geometry", "stylers": [{ "color": "#181818" }] },
          { "featureType": "poi.park", "elementType": "labels.text.fill", "stylers": [{ "color": "#616161" }] },
          { "featureType": "poi.park", "elementType": "labels.text.stroke", "stylers": [{ "color": "#1b1b1b" }] },
          { "featureType": "road", "elementType": "geometry.fill", "stylers": [{ "color": "#2c2c2c" }] },
          { "featureType": "road", "elementType": "labels.text.fill", "stylers": [{ "color": "#8a8a8a" }] },
          { "featureType": "road.arterial", "elementType": "geometry", "stylers": [{ "color": "#373737" }] },
          { "featureType": "road.highway", "elementType": "geometry", "stylers": [{ "color": "#3c3c3c" }] },
          { "featureType": "road.highway.controlled_access", "elementType": "geometry", "stylers": [{ "color": "#4e4e4e" }] },
          { "featureType": "road.local", "elementType": "labels.text.fill", "stylers": [{ "color": "#616161" }] },
          { "featureType": "transit", "elementType": "labels.text.fill", "stylers": [{ "color": "#757575" }] },
          { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#000000" }] },
          { "featureType": "water", "elementType": "labels.text.fill", "stylers": [{ "color": "#3d3d3d" }] }
        ]
      });

      carregarBairros();
    }

    async function carregarBairros() {
      const bairros = await fetchJson(BAIRROS_URL);

      bairros.forEach(b => {
        const coordsText = b.Poligono || '';
        if (!coordsText) return;

        const coordPairs = coordsText.split(';').map(pair => {
          const [lat, lng] = pair.trim().split(',').map(Number);
          return { lat, lng };
        }).filter(p => !isNaN(p.lat) && !isNaN(p.lng));

        if (coordPairs.length < 3) return;

        const reputacao = parseFloat(b.ReputacaoComp || 0);
        const cor = getCorByReputacao(reputacao);
        const nome = b.Nome || 'Bairro';
        const texto = `${nome} (${reputacao.toFixed(1)}⭐)`;

        const poligono = new google.maps.Polygon({
          paths: coordPairs,
          strokeColor: cor,
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: cor,
          fillOpacity: 0.2,
          map: map
        });

        // Centro do polígono para colocar o nome
        const centro = calcularCentroide(coordPairs);

        const div = document.createElement('div');
        div.className = 'map-label';
        div.textContent = texto;

        const label = new google.maps.OverlayView();
        label.onAdd = function () {
          const pane = this.getPanes().overlayLayer;
          pane.appendChild(div);
        };
        label.draw = function () {
          const projection = this.getProjection();
          const pos = projection.fromLatLngToDivPixel(new google.maps.LatLng(centro.lat, centro.lng));
          div.style.left = pos.x + 'px';
          div.style.top = pos.y + 'px';
        };
        label.onRemove = function () {
          div.parentNode.removeChild(div);
        };
        label.setMap(map);
      });
    }

    function calcularCentroide(pontos) {
      let lat = 0, lng = 0;
      pontos.forEach(p => {
        lat += p.lat;
        lng += p.lng;
      });
      return { lat: lat / pontos.length, lng: lng / pontos.length };
    }
  </script>
</body>
</html>



