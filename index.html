<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa Vizinhança Viva - Bairros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: calc(100% - 300px);
      float: left;
    }
    #painel {
      width: 300px;
      height: 100%;
      float: right;
      background: #1e1e1e;
      color: #fff;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      display: none;
    }
    .map-label {
      position: absolute;
      background-color: transparent;
      color: #ffffff;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      pointer-events: none;
      transform: translate(-50%, -50%);
      text-shadow: 0 0 3px #000;
    }
    .estrela {
      color: gold;
      font-size: 16px;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap" async defer></script>
</head>
<body>
  <div id="map"></div>
  <div id="painel">
    <h2 id="nome-bairro">Selecione um bairro</h2>
    <p id="descricao-bairro"></p>
    <p><strong>Reputação geral:</strong> <span id="media-geral"></span></p>
    <div id="notas-categorias"></div>
    <h3>Comentários recentes</h3>
    <ul id="comentarios"></ul>
    <h3>Nova avaliação</h3>
    <form id="form-avaliacao">
      <label>Tipo de usuário:</label><br>
      <select name="tipo">
        <option value="morador">Morador</option>
        <option value="visitante">Visitante</option>
      </select><br><br>
      <label>Limpeza:</label><br>
      <input type="number" name="limpeza" min="1" max="5"><br>
      <label>Segurança:</label><br>
      <input type="number" name="seguranca" min="1" max="5"><br>
      <label>Barulho:</label><br>
      <input type="number" name="barulho" min="1" max="5"><br>
      <label>Comentário:</label><br>
      <textarea name="comentario" rows="3"></textarea><br><br>
      <button type="submit">Enviar</button>
    </form>
  </div>

  <script>
    const BAIRROS_URL = 'https://script.google.com/macros/s/AKfycbwa8dX3rPfxyD83ow_11KtHewoKk5N1a25pHxYHh_hj8QSgSTzl8zXJSasy-Hr_GWDf0A/exec?sheet=Bairros';

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ffffff'; // branco
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return JSON.parse(JSON.parse(text));
      }
    }

    let map;

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const center = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            criarMapa(center, 15);
          },
          () => iniciarComCentroPadrao()
        );
      } else {
        iniciarComCentroPadrao();
      }
    }

    function iniciarComCentroPadrao() {
      const center = { lat: -19.82, lng: -40.27 };
      criarMapa(center, 12);
    }

    function criarMapa(center, zoom) {
      map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom,
        streetViewControl: false,
        mapTypeControl: false,
        styles: [ // dark theme
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
          { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#757575" }] },
          { featureType: "administrative.country", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
          { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#bdbdbd" }] },
          { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
          { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#181818" }] },
          { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#2c2c2c" }] },
          { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }] }
        ]
      });

      // Ocultar painel ao clicar fora dos polígonos
      map.addListener('click', () => {
        document.getElementById("painel").style.display = "none";
      });

      carregarBairros();
    }

    async function carregarBairros() {
      const bairros = await fetchJson(BAIRROS_URL);

      bairros.forEach(b => {
        const coordsText = b.Poligono || '';
        if (!coordsText) return;

        const coordPairs = coordsText.split(';').map(pair => {
          const [lat, lng] = pair.trim().split(',').map(Number);
          return { lat, lng };
        }).filter(p => !isNaN(p.lat) && !isNaN(p.lng));

        if (coordPairs.length < 3) return;

        const reputacao = parseFloat(b.ReputacaoComp);
        const cor = getCorByReputacao(reputacao);
        const nome = b.Nome || 'Bairro';
        const descricao = b.Resumo_IA || 'Sem descrição';
        const comentarios = (b.Comentarios || '').split('|').filter(c => c);
        const categorias = ['Limpeza', 'Segurança', 'Barulho'];

        const poligono = new google.maps.Polygon({
          paths: coordPairs,
          strokeColor: cor,
          strokeOpacity: 1,
          strokeWeight: 2,
          fillColor: cor,
          fillOpacity: isNaN(reputacao) ? 0 : 0.2,
          map: map
        });

        poligono.addListener('click', (event) => {
          document.getElementById("nome-bairro").innerText = nome;
          document.getElementById("descricao-bairro").innerText = descricao;
          document.getElementById("media-geral").innerText = isNaN(reputacao) ? '0.0 ⭐' : `${reputacao.toFixed(1)} ⭐`;

          const notasDiv = document.getElementById("notas-categorias");
          notasDiv.innerHTML = '';
          categorias.forEach(cat => {
            const nota = b[cat] || '0';
            notasDiv.innerHTML += `<p><strong>${cat}:</strong> ${nota} ⭐</p>`;
          });

          const lista = document.getElementById("comentarios");
          lista.innerHTML = '';
          comentarios.slice(0, 5).forEach(c => {
            const li = document.createElement('li');
            li.textContent = c;
            lista.appendChild(li);
          });

          document.getElementById("painel").style.display = "block";
        });

        // Label no centro
        const centro = calcularCentroide(coordPairs);
        const texto = `${nome} (${isNaN(reputacao) ? '0.0' : reputacao.toFixed(1)}⭐)`;
        const div = document.createElement('div');
        div.className = 'map-label';
        div.textContent = texto;

        const label = new google.maps.OverlayView();
        label.onAdd = function () {
          this.getPanes().overlayLayer.appendChild(div);
        };
        label.draw = function () {
          const proj = this.getProjection();
          const pos = proj.fromLatLngToDivPixel(new google.maps.LatLng(centro.lat, centro.lng));
          div.style.left = pos.x + 'px';
          div.style.top = pos.y + 'px';
        };
        label.setMap(map);
      });
    }

    function calcularCentroide(pontos) {
      let lat = 0, lng = 0;
      pontos.forEach(p => {
        lat += p.lat;
        lng += p.lng;
      });
      return { lat: lat / pontos.length, lng: lng / pontos.length };
    }
  </script>
</body>
</html>

