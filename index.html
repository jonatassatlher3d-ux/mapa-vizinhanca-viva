<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Vizinhança Viva</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background-color: #1e1e1e;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      display: none;
      z-index: 10;
    }

    label, input, select, textarea, button {
      display: block;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    input, select, textarea {
      padding: 5px;
      border: none;
      border-radius: 4px;
    }

    button {
      background-color: #28a745;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>Bairro Selecionado</h2>
    <div id="bairro-nome">Clique em um bairro</div>

    <form id="form-avaliacao" style="display: none;">
      <label for="Seguranca">Segurança</label>
      <select name="Seguranca" required>
        <option value="">Selecione</option>
        <option value="1">1 - Péssimo</option>
        <option value="2">2 - Ruim</option>
        <option value="3">3 - Médio</option>
        <option value="4">4 - Bom</option>
        <option value="5">5 - Excelente</option>
      </select>

      <label for="Ruido">Ruído</label>
      <select name="Ruido" required>
        <option value="">Selecione</option>
        <option value="1">1 - Muito alto</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 - Muito silencioso</option>
      </select>

      <label for="Limpeza">Limpeza</label>
      <select name="Limpeza" required>
        <option value="">Selecione</option>
        <option value="1">1 - Muito sujo</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 - Muito limpo</option>
      </select>

      <label for="Tranquilidade">Tranquilidade</label>
      <select name="Tranquilidade" required>
        <option value="">Selecione</option>
        <option value="1">1 - Muito agitado</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 - Muito tranquilo</option>
      </select>

      <label for="IdealCriancas">Ideal para crianças?</label>
      <select name="IdealCriancas" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label for="OtimosVizinhos">Ótimos vizinhos?</label>
      <select name="OtimosVizinhos" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label for="Comentario">Comentário</label>
      <textarea name="Comentario" rows="3"></textarea>

      <button type="submit">Enviar Avaliação</button>
    </form>
  </div>

  <script>
    let map;
    let bairroSelecionado = "";

    const estilosDark = [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "transit", stylers: [{ visibility: "off" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
      { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
      { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
      { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
    ];

    function hideSidebar() {
      document.getElementById("sidebar").style.display = "none";
      document.getElementById("form-avaliacao").style.display = "none";
      bairroSelecionado = "";
    }

    function initMap() {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLocation = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        map = new google.maps.Map(document.getElementById("map"), {
          center: userLocation,
          zoom: 15,
          styles: estilosDark
        });

        const url = "https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec?action=getBairros";

        fetch(url)
          .then(resp => resp.json())
          .then(data => {
            data.forEach(bairro => {
              if (bairro.Poligono) {
                const path = bairro.Poligono
                  .split(";")
                  .map(p => {
                    const [lat, lng] = p.trim().split(",").map(Number);
                    return { lat, lng };
                  });

                const polygon = new google.maps.Polygon({
                  paths: path,
                  strokeColor: "#FF0000",
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: "#FF0000",
                  fillOpacity: 0.35,
                });

                polygon.setMap(map);

                polygon.addListener("click", (e) => {
  e.stopPropagation();
                  bairroSelecionado = bairro.Nome;
                  document.getElementById("bairro-nome").innerText = bairro.Nome;
                  document.getElementById("sidebar").style.display = "block";
                  document.getElementById("form-avaliacao").style.display = "block";
                });
              }
            });
          });

        map.addListener("click", () => {
          hideSidebar();
        });
      });
    }

    document.getElementById("form-avaliacao").addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = {
        Bairro: bairroSelecionado,
        Seguranca: formData.get("Seguranca"),
        Ruido: formData.get("Ruido"),
        Limpeza: formData.get("Limpeza"),
        Tranquilidade: formData.get("Tranquilidade"),
        IdealCriancas: formData.get("IdealCriancas"),
        OtimosVizinhos: formData.get("OtimosVizinhos"),
        Comentario: formData.get("Comentario")
      };

      fetch("https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec", {
        method: "POST",
        body: JSON.stringify(data)
      })
        .then(resp => resp.json())
        .then(resp => {
          alert("Avaliação enviada com sucesso!");
          document.getElementById("form-avaliacao").reset();
          hideSidebar();
        })
        .catch(err => {
          alert("Erro ao enviar avaliação.");
          console.error(err);
        });
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap">
  </script>
</body>
</html>

