<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Vizinhança Viva</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background: #000; /* evita qualquer flash claro */
    }

    /* Mapa sempre ocupando 100% (sem animar largura) */
    #map {
      height: 100%;
      width: 100%;
    }

    /* Sidebar como overlay: sem “abrir espaço” no layout */
    #sidebar {
      position: absolute; right: 0; top: 0;
      width: 300px; height: 100%;
      background-color: #1e1e1e; color: white;
      padding: 20px; box-sizing: border-box; overflow-y: auto;
      z-index: 2;
      /* animação suave sem mostrar nada por baixo */
      transform: translateX(100%);
      transition: transform 0.25s ease-in-out;
      backface-visibility: hidden;
      will-change: transform;
      pointer-events: none; /* não clica quando oculto */
    }
    /* Estado aberto */
    #sidebar.open {
      transform: translateX(0);
      pointer-events: auto;
    }

    label, textarea, button { display: block; margin-top: 10px; width: 100%; box-sizing: border-box; }
    textarea { padding: 5px; border: none; border-radius: 4px; }
    button {
      background-color: #28a745; color: white; padding: 10px;
      border: none; border-radius: 4px; cursor: pointer; margin-top: 14px;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    button:hover:not([disabled]){ background-color:#218838; }

    /* Toasts */
    #toast-container{ position:fixed; bottom:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
    .toast{
      padding:12px 16px; border-radius:6px; color:#fff; font-size:14px;
      box-shadow:0 2px 8px rgba(0,0,0,.3); opacity:0; transform:translateY(20px);
      animation:slideIn .3s forwards, fadeOut .5s ease forwards 3s;
    }
    .toast.success{ background:#28a745; } .toast.error{ background:#dc3545; }
    @keyframes slideIn { to{ opacity:1; transform:translateY(0); } }
    @keyframes fadeOut { to{ opacity:0; transform:translateY(20px); } }

    /* Rótulos no mapa (texto puro) */
    .map-label{
      position:absolute; transform:translate(-50%, -100%); white-space:nowrap; pointer-events:none;
      background:transparent; color:#fff; font-size:12px; font-weight:bold; text-shadow:0 1px 2px rgba(0,0,0,.8);
    }

    /* Estrelas */
    .rating-group{ margin-top:8px; }
    .rating-label{ margin-bottom:4px; font-size:14px; color:#fff; }
    .rating{ display:inline-flex; gap:6px; user-select:none; }
    .rating .star{ font-size:22px; cursor:pointer; color:#666; transition:transform .08s ease, color .08s ease; }
    .rating .star.active,.rating .star.hover{ color:#ffc107; }
    .rating .star:active{ transform:scale(.92); }
    .hidden-input{ display:none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="sidebar">
    <h2>Bairro Selecionado</h2>
    <div id="bairro-nome">Clique em um bairro</div>

    <form id="form-avaliacao" style="display:none;">
      <!-- Segurança -->
      <div class="rating-group" data-name="Seguranca">
        <div class="rating-label">Segurança</div>
        <input class="hidden-input" type="hidden" name="Seguranca" />
        <div class="rating" role="radiogroup" aria-label="Segurança">
          <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span><span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Ruído -->
      <div class="rating-group" data-name="Ruido">
        <div class="rating-label">Ruído</div>
        <input class="hidden-input" type="hidden" name="Ruido" />
        <div class="rating" role="radiogroup" aria-label="Ruído">
          <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span><span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Limpeza -->
      <div class="rating-group" data-name="Limpeza">
        <div class="rating-label">Limpeza</div>
        <input class="hidden-input" type="hidden" name="Limpeza" />
        <div class="rating" role="radiogroup" aria-label="Limpeza">
          <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span><span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Tranquilidade -->
      <div class="rating-group" data-name="Tranquilidade">
        <div class="rating-label">Tranquilidade</div>
        <input class="hidden-input" type="hidden" name="Tranquilidade" />
        <div class="rating" role="radiogroup" aria-label="Tranquilidade">
          <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span><span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Ideal para crianças -->
      <div class="rating-group" data-name="IdealCriancas">
        <div class="rating-label">Ideal para crianças</div>
        <input class="hidden-input" type="hidden" name="IdealCriancas" />
        <div class="rating" role="radiogroup" aria-label="Ideal para crianças">
          <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span><span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Ótimos vizinhos -->
      <div class="rating-group" data-name="OtimosVizinhos">
        <div class="rating-label">Ótimos vizinhos</div>
        <input class="hidden-input" type="hidden" name="OtimosVizinhos" />
        <div class="rating" role="radiogroup" aria-label="Ótimos vizinhos">
          <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span><span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <label for="Comentario">Comentário</label>
      <textarea name="Comentario" rows="3" placeholder="Conte mais sobre sua experiência..."></textarea>

      <button id="submit-btn" type="submit">Enviar Avaliação</button>
    </form>
  </div>

  <!-- Toasts -->
  <div id="toast-container"></div>

  <script>
    let map;
    let bairroSelecionado = "";
    let isSubmitting = false;

    const estilosDark = [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "poi.business", stylers: [{ visibility: "off" }] },
      { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
      { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
      { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
      { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
      { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
      { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
    ];

    const WEBAPP_GET = "https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec?action=getBairros";
    const WEBAPP_POST = "https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec";

    function showToast(msg, type="success"){
      const c=document.getElementById("toast-container");
      const t=document.createElement("div");
      t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t);
      setTimeout(()=>t.remove(),4000);
    }

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ffffff';
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    function getPolygonCenter(path){
      let lat=0,lng=0; path.forEach(p=>{lat+=p.lat; lng+=p.lng;});
      return {lat:lat/path.length, lng:lng/path.length};
    }

    function addTextLabel(map, position, text){
      const div=document.createElement('div'); div.className='map-label'; div.textContent=text;
      const ov=new google.maps.OverlayView();
      ov.onAdd=function(){ this.getPanes().overlayLayer.appendChild(div); };
      ov.draw=function(){
        const proj=this.getProjection(); if(!proj) return;
        const pt=proj.fromLatLngToDivPixel(new google.maps.LatLng(position.lat, position.lng));
        if(pt){ div.style.left=pt.x+'px'; div.style.top=pt.y+'px'; }
      };
      ov.onRemove=function(){ if(div.parentNode) div.parentNode.removeChild(div); };
      ov.setMap(map); return ov;
    }

    function setupStarRatings(){
      document.querySelectorAll('.rating-group').forEach(group=>{
        const hidden=group.querySelector('.hidden-input');
        const stars=group.querySelectorAll('.star');
        let current=0;
        const paint=(val,hover=false)=>{
          stars.forEach(s=>{
            const v=+s.dataset.value;
            s.classList.toggle(hover?'hover':'active', v<=val);
            if(!hover) s.classList.remove('hover');
          });
        };
        stars.forEach(s=>{
          s.addEventListener('mouseenter',()=>paint(+s.dataset.value,true));
          s.addEventListener('mouseleave',()=>paint(current));
          s.addEventListener('click',()=>{
            current=+s.dataset.value; hidden.value=String(current); paint(current);
          });
        });
      });
    }

    function validateStarsRequired(){
      const req=["Seguranca","Ruido","Limpeza","Tranquilidade","IdealCriancas","OtimosVizinhos"];
      for(const name of req){
        const v=document.querySelector(`input[name="${name}"]`)?.value;
        if(!v){ showToast(`Selecione as estrelas para: ${name}`,"error"); return false; }
      }
      return true;
    }

    function openSidebar(bairroNome){
      bairroSelecionado=bairroNome;
      document.getElementById("bairro-nome").innerText=bairroNome;
      const sb=document.getElementById("sidebar");
      document.getElementById("form-avaliacao").style.display="block";
      sb.classList.add("open"); // slick slide-in
    }
    function closeSidebar(){
      const sb=document.getElementById("sidebar");
      document.getElementById("form-avaliacao").style.display="none";
      sb.classList.remove("open");
    }

    function initMap(){
      const start = (center)=> {
        map = new google.maps.Map(document.getElementById("map"), {
          center, zoom: 15, styles: estilosDark, streetViewControl:false, mapTypeControl:false
        });

        // Fechar ao clicar no mapa
        map.addListener("click", closeSidebar);

        // Carrega polígonos
        fetch(WEBAPP_GET)
          .then(r=>r.json())
          .then(rows=>{
            rows.forEach(bairro=>{
              if(!bairro.Poligono) return;
              const path=bairro.Poligono.split(";").map(p=>{
                const [lat,lng]=p.trim().split(",").map(Number);
                return {lat, lng};
              });
              const rep=parseFloat(bairro.ReputacaoComp);
              const hasRep=!isNaN(rep) && rep>0;
              const cor=hasRep?getCorByReputacao(rep):"#ffffff";

              const poly=new google.maps.Polygon({
                paths:path, strokeColor:cor, strokeOpacity:.9, strokeWeight:2,
                fillColor:cor, fillOpacity:hasRep?0.35:0.0
              });
              poly.setMap(map);

              const labelPos=getPolygonCenter(path);
              const labelText=hasRep?`${bairro.Nome} (${rep.toFixed(1)}⭐)`:bairro.Nome;
              addTextLabel(map,labelPos,labelText);

              poly.addListener("click", ()=> openSidebar(bairro.Nome));
            });
            setupStarRatings();
          })
          .catch(()=>showToast("Erro ao carregar bairros.","error"));
      };

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          pos=>start({lat:pos.coords.latitude,lng:pos.coords.longitude}),
          ()=>start({lat:-20.3155,lng:-40.3128}) // fallback: Vitória-ES
        );
      } else {
        start({lat:-20.3155,lng:-40.3128});
      }
    }

    document.getElementById("form-avaliacao").addEventListener("submit", async function(e){
      e.preventDefault();
      if(isSubmitting) return;
      if(!validateStarsRequired()) return;

      const btn=document.getElementById("submit-btn");
      const originalText=btn.textContent;
      isSubmitting=true; btn.disabled=true; btn.textContent="Enviando…";

      const fd=new FormData(this);
      const data={}; fd.forEach((v,k)=>data[k]=v);
      data.Bairro=bairroSelecionado;

      try{
        const resp=await fetch(WEBAPP_POST,{ method:"POST", body:JSON.stringify(data) });
        await resp.json();
        showToast("Avaliação enviada com sucesso!","success");
        this.reset();
        document.querySelectorAll('.star').forEach(s=>s.classList.remove('active','hover'));
        document.querySelectorAll('.hidden-input').forEach(i=>i.value="");
        closeSidebar();
      }catch{
        showToast("Erro ao enviar avaliação.","error");
      }finally{
        btn.disabled=false; btn.textContent=originalText; isSubmitting=false;
      }
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap"></script>
</body>
</html>
