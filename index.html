<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Vizinhança Viva</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    #sidebar {
      width: 300px;
      height: 100%;
      background-color: #1e1e1e;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      position: absolute;
      right: 0;
      top: 0;
      display: none;
      z-index: 1;
    }

    label, input, textarea, button {
      display: block;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      padding: 5px;
      border: none;
      border-radius: 4px;
    }

    button {
      background-color: #28a745;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 14px;
    }

    button:hover {
      background-color: #218838;
    }

    /* Estrelas */
    .rating-group {
      margin-top: 8px;
    }
    .rating-label {
      margin-bottom: 4px;
      font-size: 14px;
      color: #fff;
    }
    .rating {
      display: inline-flex;
      gap: 6px;
      user-select: none;
    }
    .rating .star {
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      color: #666;            /* cor estrela “apagada” */
      transition: transform 0.08s ease, color 0.08s ease;
    }
    .rating .star.active,
    .rating .star.hover {
      color: #ffc107;         /* dourado */
    }
    .rating .star:active {
      transform: scale(0.92);
    }
    .hidden-input {
      display: none;
    }

    /* Rótulos sem fundo (apenas texto no mapa) */
    .map-label {
      position: absolute;
      transform: translate(-50%, -100%);
      white-space: nowrap;
      pointer-events: none;
      background: transparent;
      padding: 0;
      margin: 0;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="sidebar">
    <h2>Bairro Selecionado</h2>
    <div id="bairro-nome">Clique em um bairro</div>

    <form id="form-avaliacao" style="display: none;">
      <!-- Segurança -->
      <div class="rating-group" data-name="Seguranca">
        <div class="rating-label">Segurança</div>
        <input class="hidden-input" type="hidden" name="Seguranca" />
        <div class="rating" role="radiogroup" aria-label="Segurança">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Ruído -->
      <div class="rating-group" data-name="Ruido">
        <div class="rating-label">Ruído</div>
        <input class="hidden-input" type="hidden" name="Ruido" />
        <div class="rating" role="radiogroup" aria-label="Ruído">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Limpeza -->
      <div class="rating-group" data-name="Limpeza">
        <div class="rating-label">Limpeza</div>
        <input class="hidden-input" type="hidden" name="Limpeza" />
        <div class="rating" role="radiogroup" aria-label="Limpeza">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Tranquilidade -->
      <div class="rating-group" data-name="Tranquilidade">
        <div class="rating-label">Tranquilidade</div>
        <input class="hidden-input" type="hidden" name="Tranquilidade" />
        <div class="rating" role="radiogroup" aria-label="Tranquilidade">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Ideal para crianças -->
      <div class="rating-group" data-name="IdealCriancas">
        <div class="rating-label">Ideal para crianças</div>
        <input class="hidden-input" type="hidden" name="IdealCriancas" />
        <div class="rating" role="radiogroup" aria-label="Ideal para crianças">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <!-- Ótimos vizinhos -->
      <div class="rating-group" data-name="OtimosVizinhos">
        <div class="rating-label">Ótimos vizinhos</div>
        <input class="hidden-input" type="hidden" name="OtimosVizinhos" />
        <div class="rating" role="radiogroup" aria-label="Ótimos vizinhos">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <label for="Comentario">Comentário</label>
      <textarea name="Comentario" rows="3" placeholder="Conte mais sobre sua experiência..."></textarea>

      <button type="submit">Enviar Avaliação</button>
    </form>
  </div>

  <script>
    let map;
    let bairroSelecionado = "";

    const estilosDark = [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "poi.business", stylers: [{ visibility: "off" }] },
      { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
      { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
      { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
      { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
      { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
      { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
    ];

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ffffff';
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    // Centro aproximado do polígono (média simples)
    function getPolygonCenter(path) {
      let lat = 0, lng = 0;
      path.forEach(p => { lat += p.lat; lng += p.lng; });
      return { lat: lat / path.length, lng: lng / path.length };
    }

    // OverlayView para rótulos de texto sem fundo
    function addTextLabel(map, position, text) {
      const div = document.createElement('div');
      div.className = 'map-label';
      div.textContent = text;

      const overlay = new google.maps.OverlayView();
      overlay.onAdd = function() {
        const pane = this.getPanes().overlayLayer;
        pane.appendChild(div);
      };
      overlay.draw = function() {
        const proj = this.getProjection();
        if (!proj) return;
        const point = proj.fromLatLngToDivPixel(new google.maps.LatLng(position.lat, position.lng));
        if (point) {
          div.style.left = point.x + 'px';
          div.style.top  = point.y + 'px';
        }
      };
      overlay.onRemove = function() {
        if (div.parentNode) div.parentNode.removeChild(div);
      };
      overlay.setMap(map);
      return overlay;
    }

    // ---- Estrelas: lógica de seleção/hover e sincronização com <input hidden> ----
    function setupStarRatings() {
      document.querySelectorAll('.rating-group').forEach(group => {
        const hiddenInput = group.querySelector('.hidden-input');
        const stars = group.querySelectorAll('.star');
        let current = 0; // valor selecionado

        const paint = (val, hover=false) => {
          stars.forEach(star => {
            const v = Number(star.dataset.value);
            star.classList.toggle(hover ? 'hover' : 'active', v <= val);
            if (!hover) star.classList.remove('hover');
          });
        };

        stars.forEach(star => {
          star.addEventListener('mouseenter', () => paint(Number(star.dataset.value), true));
          star.addEventListener('mouseleave', () => paint(current));
          star.addEventListener('click', () => {
            current = Number(star.dataset.value);
            hiddenInput.value = String(current);
            paint(current);
          });
        });
      });
    }

    function validateStarsRequired() {
      const requiredNames = ["Seguranca","Ruido","Limpeza","Tranquilidade","IdealCriancas","OtimosVizinhos"];
      for (const name of requiredNames) {
        const val = document.querySelector(`input[name="${name}"]`)?.value;
        if (!val || isNaN(Number(val)) || Number(val) < 1) {
          alert(`Selecione de 1 a 5 estrelas para: ${name}.`);
          return false;
        }
      }
      return true;
    }

    function initMap() {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };

        map = new google.maps.Map(document.getElementById("map"), {
          center: userLocation,
          zoom: 15,
          styles: estilosDark
        });

        // Clicar fora dos polígonos fecha o painel
        map.addListener("click", () => {
          document.getElementById("sidebar").style.display = "none";
          document.getElementById("form-avaliacao").style.display = "none";
          document.getElementById("map").style.width = "100%";
        });

        const url = "https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec?action=getBairros";

        fetch(url)
          .then(resp => resp.json())
          .then(data => {
            data.forEach(bairro => {
              if (!bairro.Poligono) return;

              const path = bairro.Poligono
                .split(";")
                .map(p => {
                  const [lat, lng] = p.trim().split(",").map(Number);
                  return { lat, lng };
                });

              const rep = parseFloat(bairro.ReputacaoComp);
              const hasRep = !isNaN(rep) && rep > 0;
              const cor = hasRep ? getCorByReputacao(rep) : '#ffffff';

              const polygon = new google.maps.Polygon({
                paths: path,
                strokeColor: cor,
                strokeOpacity: 0.9,
                strokeWeight: 2,
                fillColor: cor,
                fillOpacity: hasRep ? 0.35 : 0.0
              });
              polygon.setMap(map);

              // Rótulo “Nome (X.X⭐)” ou apenas Nome
              const labelPos = getPolygonCenter(path);
              const labelText = hasRep ? `${bairro.Nome} (${rep.toFixed(1)}⭐)` : bairro.Nome;
              addTextLabel(map, labelPos, labelText);

              // Clique no polígono abre painel
              polygon.addListener("click", () => {
                bairroSelecionado = bairro.Nome;
                document.getElementById("bairro-nome").innerText = bairro.Nome;
                document.getElementById("sidebar").style.display = "block";
                document.getElementById("form-avaliacao").style.display = "block";
                document.getElementById("map").style.width = "calc(100% - 300px)";
              });
            });

            // Inicializa interações das estrelas após o DOM estar pronto
            setupStarRatings();
          });
      }, () => {
        alert("Não foi possível obter sua localização.");
      });
    }

    // Envio do formulário
    document.getElementById("form-avaliacao").addEventListener("submit", function (e) {
      e.preventDefault();

      if (!validateStarsRequired()) return;

      const formData = new FormData(this);
      const data = {
        Bairro: bairroSelecionado,
        Seguranca: formData.get("Seguranca"),
        Ruido: formData.get("Ruido"),
        Limpeza: formData.get("Limpeza"),
        Tranquilidade: formData.get("Tranquilidade"),
        IdealCriancas: formData.get("IdealCriancas"),
        OtimosVizinhos: formData.get("OtimosVizinhos"),
        Comentario: formData.get("Comentario")
      };

      fetch("https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec", {
        method: "POST",
        body: JSON.stringify(data)
      })
        .then(resp => resp.json())
        .then(resp => {
          alert("Avaliação enviada com sucesso!");
          this.reset();
          // Limpa visuais das estrelas após reset
          document.querySelectorAll('.rating-group').forEach(group => {
            group.querySelectorAll('.star').forEach(s => {
              s.classList.remove('active','hover');
            });
          });
        })
        .catch(err => {
          alert("Erro ao enviar avaliação.");
          console.error(err);
        });
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap"></script>
</body>
</html>
