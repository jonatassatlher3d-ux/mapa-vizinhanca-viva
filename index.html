<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa Vizinhança Viva - Bairros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #container {
      position: relative;
      height: 100%;
      width: 100%;
    }
    #map {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #painel {
      position: absolute;
      top: 0;
      right: 0;
      width: 340px;
      height: 100%;
      background: #1e1e1e;
      color: #fff;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 2;
    }
    #painel.aberto {
      transform: translateX(0%);
    }
    .map-label {
      position: absolute;
      background-color: transparent;
      color: #ffffff;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      pointer-events: none;
      transform: translate(-50%, -50%);
      text-shadow: 0 0 3px #000;
    }
    form label {
      display: block;
      margin-top: 10px;
    }
    form input[type="number"],
    form textarea,
    form select {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
      background: #333;
      border: none;
      color: #fff;
    }
    form button {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      background: #4caf50;
      border: none;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap" async defer></script>
</head>
<body>
  <div id="container">
    <div id="map"></div>
    <div id="painel">
      <h2 id="nome-bairro">Selecione um bairro</h2>
      <p id="descricao-bairro">Descrição do bairro aqui.</p>
      <p><strong>Segurança:</strong> <span id="seguranca"></span> ⭐</p>
      <p><strong>Ruído:</strong> <span id="ruido"></span> ⭐</p>
      <p><strong>Limpeza:</strong> <span id="limpeza"></span> ⭐</p>
      <p><strong>Tranquilidade:</strong> <span id="tranquilidade"></span> ⭐</p>
      <p><strong>Ideal para crianças:</strong> <span id="criancas"></span> ⭐</p>
      <p><strong>Ótimos vizinhos:</strong> <span id="vizinhos"></span> ⭐</p>
      <p><strong>Média geral:</strong> <span id="media-geral"></span> ⭐</p>

      <h3>Comentários</h3>
      <ul id="comentarios"></ul>

      <h3>Avalie este bairro</h3>
      <form id="form-avaliacao">
        <label>Morador / Visitante</label>
        <select name="tipo">
          <option value="morador">Morador</option>
          <option value="visitante">Visitante</option>
        </select>
        <label>Segurança</label>
        <input type="number" name="seguranca" min="1" max="5">
        <label>Ruído</label>
        <input type="number" name="ruido" min="1" max="5">
        <label>Limpeza</label>
        <input type="number" name="limpeza" min="1" max="5">
        <label>Tranquilidade</label>
        <input type="number" name="tranquilidade" min="1" max="5">
        <label>Ideal para crianças</label>
        <input type="number" name="ideal-criancas" min="1" max="5">
        <label>Ótimos vizinhos</label>
        <input type="number" name="otimos-vizinhos" min="1" max="5">
        <label>Deixe seu comentário</label>
        <textarea name="comentario" rows="3"></textarea>
        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>

  <script>
    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzg15mXHH3hSbim9rcxcI62EM5W_veBmajYMLZA9KKfpierC5DbGl38lhvPEYYzCSPaig/exec';

    let map;
    window.initMap = function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => criarMapa({ lat: pos.coords.latitude, lng: pos.coords.longitude }, 15),
          () => criarMapa({ lat: -19.82, lng: -40.27 }, 12)
        );
      } else {
        criarMapa({ lat: -19.82, lng: -40.27 }, 12);
      }
    };

    function criarMapa(center, zoom) {
      map = new google.maps.Map(document.getElementById('map'), {
        center, zoom,
        streetViewControl: false,
        mapTypeControl: false,
        gestureHandling: 'greedy',
        styles: [/* estilo escuro */]
      });

      map.addListener('click', () => {
        document.getElementById("painel").classList.remove("aberto");
      });

      // Aqui você deve carregar os dados da planilha nova (via webhook ou json estático) e desenhar os bairros
      // Exemplo fictício:
      // fetch(WEBHOOK_URL + '?get=bairros')...
    }

    document.getElementById("form-avaliacao").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;
      const bairro = document.getElementById("nome-bairro").innerText;

      const payload = {
        bairro,
        tipo: form.tipo.value,
        seguranca: parseInt(form.seguranca.value) || 0,
        ruido: parseInt(form.ruido.value) || 0,
        limpeza: parseInt(form.limpeza.value) || 0,
        tranquilidade: parseInt(form.tranquilidade.value) || 0,
        idealCriancas: parseInt(form["ideal-criancas"].value) || 0,
        otimosVizinhos: parseInt(form["otimos-vizinhos"].value) || 0,
        comentario: form.comentario.value.trim()
      };

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const json = await res.json();
        if (json.success) {
          alert("Avaliação enviada com sucesso!");
          form.reset();
        } else {
          alert("Erro ao enviar avaliação.");
        }
      } catch (err) {
        alert("Erro de rede.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
