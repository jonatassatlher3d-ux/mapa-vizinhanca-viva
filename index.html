<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Vizinhança Viva</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    #sidebar {
      width: 300px;
      height: 100%;
      background-color: #1e1e1e;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      position: absolute;
      right: 0;
      top: 0;
      display: none;
      z-index: 1;
    }

    label, input, select, textarea, button {
      display: block;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    input, select, textarea {
      padding: 5px;
      border: none;
      border-radius: 4px;
    }

    button {
      background-color: #28a745;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    /* Rótulos sem fundo (apenas texto) */
    .map-label {
      position: absolute;
      transform: translate(-50%, -100%);
      white-space: nowrap;
      pointer-events: none;     /* não captura clique */
      background: transparent;  /* sem fundo */
      padding: 0;
      margin: 0;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* legibilidade no dark */
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="sidebar">
    <h2>Bairro Selecionado</h2>
    <div id="bairro-nome">Clique em um bairro</div>

    <form id="form-avaliacao" style="display: none;">
      <label for="Seguranca">Segurança</label>
      <select name="Seguranca" required>
        <option value="">Selecione</option>
        <option value="1">1 - Péssimo</option>
        <option value="2">2 - Ruim</option>
        <option value="3">3 - Médio</option>
        <option value="4">4 - Bom</option>
        <option value="5">5 - Excelente</option>
      </select>

      <label for="Ruido">Ruído</label>
      <select name="Ruido" required>
        <option value="">Selecione</option>
        <option value="1">1 - Muito alto</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 - Muito silencioso</option>
      </select>

      <label for="Limpeza">Limpeza</label>
      <select name="Limpeza" required>
        <option value="">Selecione</option>
        <option value="1">1 - Muito sujo</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 - Muito limpo</option>
      </select>

      <label for="Tranquilidade">Tranquilidade</label>
      <select name="Tranquilidade" required>
        <option value="">Selecione</option>
        <option value="1">1 - Muito agitado</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 - Muito tranquilo</option>
      </select>

      <label for="IdealCriancas">Ideal para crianças?</label>
      <select name="IdealCriancas" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label for="OtimosVizinhos">Ótimos vizinhos?</label>
      <select name="OtimosVizinhos" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>

      <label for="Comentario">Comentário</label>
      <textarea name="Comentario" rows="3"></textarea>

      <button type="submit">Enviar Avaliação</button>
    </form>
  </div>

  <script>
    let map;
    let bairroSelecionado = "";

    const estilosDark = [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "poi.business", stylers: [{ visibility: "off" }] },
      { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
      { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
      { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
      { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
      { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
      { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
    ];

    function getCorByReputacao(rep) {
      if (isNaN(rep)) return '#ffffff';
      if (rep >= 4.5) return '#4caf50';
      if (rep >= 3.5) return '#2196f3';
      if (rep >= 2.5) return '#ffeb3b';
      if (rep >= 1.5) return '#ff9800';
      return '#f44336';
    }

    // Calcula “centro” simples pelo média das coordenadas do path
    function getPolygonCenter(path) {
      let lat = 0, lng = 0;
      path.forEach(p => { lat += p.lat; lng += p.lng; });
      return { lat: lat / path.length, lng: lng / path.length };
    }

    // OverlayView para rótulos de texto sem fundo
    function addTextLabel(map, position, text) {
      const div = document.createElement('div');
      div.className = 'map-label';
      div.textContent = text;

      const overlay = new google.maps.OverlayView();
      overlay.onAdd = function() {
        const pane = this.getPanes().overlayLayer;
        pane.appendChild(div);
      };
      overlay.draw = function() {
        const proj = this.getProjection();
        if (!proj) return;
        const point = proj.fromLatLngToDivPixel(new google.maps.LatLng(position.lat, position.lng));
        if (point) {
          div.style.left = point.x + 'px';
          div.style.top  = point.y + 'px';
        }
      };
      overlay.onRemove = function() {
        if (div.parentNode) div.parentNode.removeChild(div);
      };
      overlay.setMap(map);
      return overlay;
    }

    function initMap() {
      navigator.geolocation.getCurrentPosition(pos => {
        const userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };

        map = new google.maps.Map(document.getElementById("map"), {
          center: userLocation,
          zoom: 15,
          styles: estilosDark
        });

        map.addListener("click", () => {
          document.getElementById("sidebar").style.display = "none";
          document.getElementById("form-avaliacao").style.display = "none";
          document.getElementById("map").style.width = "100%";
        });

        const url = "https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec?action=getBairros";

        fetch(url)
          .then(resp => resp.json())
          .then(data => {
            data.forEach(bairro => {
              if (!bairro.Poligono) return;

              const path = bairro.Poligono
                .split(";")
                .map(p => {
                  const [lat, lng] = p.trim().split(",").map(Number);
                  return { lat, lng };
                });

              const rep = parseFloat(bairro.ReputacaoComp);
              const hasRep = !isNaN(rep) && rep > 0;
              const cor = hasRep ? getCorByReputacao(rep) : '#ffffff';

              const polygon = new google.maps.Polygon({
                paths: path,
                strokeColor: cor,
                strokeOpacity: 0.9,
                strokeWeight: 2,
                fillColor: cor,
                fillOpacity: hasRep ? 0.35 : 0.0
              });
              polygon.setMap(map);

              // rótulo puro texto (sem fundo)
              const labelPos = getPolygonCenter(path);
              const labelText = hasRep ? `${bairro.Nome} (${rep.toFixed(1)}⭐)` : bairro.Nome;
              addTextLabel(map, labelPos, labelText);

              polygon.addListener("click", () => {
                bairroSelecionado = bairro.Nome;
                document.getElementById("bairro-nome").innerText = bairro.Nome;
                document.getElementById("sidebar").style.display = "block";
                document.getElementById("form-avaliacao").style.display = "block";
                document.getElementById("map").style.width = "calc(100% - 300px)";
              });
            });
          });
      }, () => {
        alert("Não foi possível obter sua localização.");
      });
    }

    document.getElementById("form-avaliacao").addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = {
        Bairro: bairroSelecionado,
        Seguranca: formData.get("Seguranca"),
        Ruido: formData.get("Ruido"),
        Limpeza: formData.get("Limpeza"),
        Tranquilidade: formData.get("Tranquilidade"),
        IdealCriancas: formData.get("IdealCriancas"),
        OtimosVizinhos: formData.get("OtimosVizinhos"),
        Comentario: formData.get("Comentario")
      };

      fetch("https://script.google.com/macros/s/AKfycbwPoPvZ9rvlxi_zKNFLU9PUylYNOmb9it6sSiY1FYGbQTeZVvXiCLi47iRK5ZE_t4oOXg/exec", {
        method: "POST",
        body: JSON.stringify(data)
      })
        .then(resp => resp.json())
        .then(resp => {
          alert("Avaliação enviada com sucesso!");
          this.reset();
        })
        .catch(err => {
          alert("Erro ao enviar avaliação.");
          console.error(err);
        });
    });
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap"></script>
</body>
</html>
