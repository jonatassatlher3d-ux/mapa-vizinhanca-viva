<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa Vizinhaça Viva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { height:100%; width:100%; }
    .info-window { font-family: Arial, sans-serif; font-size: 14px; max-width: 260px; }
    .badge { padding:4px 8px; border-radius:4px; color:#fff; display:inline-block; margin-bottom:6px; font-weight:600; }
    .title { font-size:16px; font-weight:700; margin-bottom:4px; }
    .small { font-size:12px; color:#555; }
    a { color: #1a73e8; text-decoration:none; }
  </style>
  <!-- Versão estável da API com callback para initMap -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap" async defer></script>
</head>
<body>
  <div id="map"></div>

  <script>
    const RUAS_URL = 'https://script.google.com/macros/s/AKfycbwa8dX3rPfxyD83ow_11KtHewoKk5N1a25pHxYHh_hj8QSgSTzl8zXJSasy-Hr_GWDf0A/exec?sheet=Ruas';
    const ALERTAS_URL = 'https://script.google.com/macros/s/AKfycbwa8dX3rPfxyD83ow_11KtHewoKk5N1a25pHxYHh_hj8QSgSTzl8zXJSasy-Hr_GWDf0A/exec?sheet=AlertasTemporarios';

    async function fetchJson(url) {
      const res = await fetch(url);
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return JSON.parse(JSON.parse(text));
      }
    }

    function createCircleIcon(color) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: color || '#777',
        fillOpacity: 0.9,
        strokeWeight: 1,
        strokeColor: '#222'
      };
    }

    // chamada automaticamente pela API via callback
    async function initMap() {
      const urlParams = new URLSearchParams(window.location.search);
      const latParam = parseFloat(urlParams.get('lat'));
      const lngParam = parseFloat(urlParams.get('lng'));

      const defaultCenter = { lat: -19.82, lng: -40.27 }; // Aracruz fallback
      const center = (!isNaN(latParam) && !isNaN(lngParam)) ? { lat: latParam, lng: lngParam } : defaultCenter;

      const map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom: 13,
        streetViewControl: false,
        mapTypeControl: false,
      });

      const [ruas, alertas] = await Promise.all([
        fetchJson(RUAS_URL),
        fetchJson(ALERTAS_URL)
      ]);

      // Marcadores de ruas
      ruas.forEach(r => {
        if (!r.Central_Point) return;
        const parts = r.Central_Point.split(',').map(s => parseFloat(s.trim()));
        if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return;

        const position = { lat: parts[0], lng: parts[1] };
        const reputacao = parseFloat(r.ReputacaoComp || 0).toFixed(2);
        const cor = r.Cor_Reputacao || '#888';

        const marker = new google.maps.Marker({
          position,
          map,
          title: `${r.Nome} — Reputação: ${reputacao}`,
          icon: {
  url: `https://via.placeholder.com/32/${cor.replace('#','')}/ffffff.png?text=+`,
  scaledSize: new google.maps.Size(32, 32)
}
        });

        const resumo = (typeof r.Resumo_IA === 'string') ? r.Resumo_IA : '';
        const truncated = resumo.length > 200 ? resumo.slice(0, 200) + '...' : resumo;

        const infoContent = `
          <div class="info-window">
            <div class="badge" style="background:${cor};">Reputação: ${reputacao}</div>
            <div class="title">${r.Nome || 'Rua sem nome'}</div>
            <div class="small">${truncated}</div>
            <div style="margin-top:6px;">
              <a href="#" onclick="openGlideDetail('${(r.DeepLink||'')}')">Ver no app</a>
            </div>
          </div>
        `;
        const infowindow = new google.maps.InfoWindow({ content: infoContent });
        marker.addListener('click', () => infowindow.open({ map, anchor: marker }));
      });

      // Ícones de alerta
      const iconMap = {
        'Buraco': 'https://images.emojiterra.com/google/noto-emoji/unicode-16.0/color/1024px/1f573.png',
        'Entulho': 'https://w7.pngwing.com/pngs/241/366/png-transparent-rubbish-bins-waste-paper-baskets-emoji-sticker-emoji-glass-waste-containment-waste.png',
        'Queimada': 'https://e7.pngegg.com/pngimages/358/307/png-clipart-fire-illustration-emoji-fire-flame-heater-repairman-leaf-orange-thumbnail.png',
        'Foco de mosquito': 'https://api.hub.jhu.edu/factory/sites/default/files/styles/hub_medium/public/mosquito_emoji120318_0.jpg',
        'Obstrução': 'https://cdn-icons-png.flaticon.com/512/2228/2228942.png',
        'Ameaça animal': 'https://em-content.zobj.net/source/apple/81/snake_1f40d.png'
      };

      alertas.forEach(a => {
        if (!a.Localizacao) return;
        const parts = a.Localizacao.split(',').map(s => parseFloat(s.trim()));
        if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) return;
        const position = { lat: parts[0], lng: parts[1] };

        const tipo = a.Tipo_Alerta || 'Alerta';
        const titulo = a.Titulo_Alerta || tipo;
        const status = a.Status || '';
        const descricao = a.Descricao || '';
        const confirms = a.Confirmacoes || 0;

        const marker = new google.maps.Marker({
          position,
          map,
          title: titulo,
          icon: {
            url: iconMap[tipo] || null,
            scaledSize: new google.maps.Size(32, 32)
          }
        });

        const infoContent = `
          <div class="info-window">
            <div class="title">${titulo}</div>
            <div>Status: ${status}</div>
            <div>${descricao}</div>
            <div>Confirmações: ${confirms}</div>
          </div>
        `;
        const infowindow = new google.maps.InfoWindow({ content: infoContent });
        marker.addListener('click', () => infowindow.open({ map, anchor: marker }));
      });
    }

    function openGlideDetail(linkOrFragment) {
      if (!linkOrFragment) {
        alert('Link da rua não disponível');
        return;
      }

      if (linkOrFragment.startsWith('http')) {
        window.open(linkOrFragment, '_blank');
        return;
      }

      const base = 'https://vizinhancaviva.glide.page';
      const fullUrl = linkOrFragment.startsWith('#') ? `${base}/${linkOrFragment}` : `${base}/${linkOrFragment}`;
      window.open(fullUrl, '_blank');
    }
  </script>
</body>
</html>

