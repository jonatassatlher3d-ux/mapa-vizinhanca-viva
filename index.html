<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa Vizinhança Viva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .info-window { font-family: Arial, sans-serif; font-size: 14px; max-width: 260px; }
    .badge { padding: 4px 8px; border-radius: 4px; color: #fff; display: inline-block; margin-bottom: 6px; font-weight: 600; }
    .title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .small { font-size: 12px; color: #bbb; }
    a { color: #90caf9; text-decoration: none; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDUUK4AquwV07HbeSvPb7clw_dcc216Ik&callback=initMap" async defer></script>
</head>
<body>
  <div id="map"></div>

  <script>
    const RUAS_URL = 'https://script.google.com/macros/s/AKfycbwa8dX3rPfxyD83ow_11KtHewoKk5N1a25pHxYHh_hj8QSgSTzl8zXJSasy-Hr_GWDf0A/exec?sheet=Ruas';

    async function fetchJson(url) {
      const res = await fetch(url);
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return JSON.parse(JSON.parse(text));
      }
    }

    function getColorByReputacao(reputacao) {
      if (isNaN(reputacao)) return '#e53935'; // fallback vermelho
      if (reputacao >= 4.5) return '#43a047';
      if (reputacao >= 3.5) return '#1e88e5';
      if (reputacao >= 2.5) return '#fdd835';
      if (reputacao >= 1.5) return '#fb8c00';
      return '#e53935';
    }

    async function initMap() {
      const urlParams = new URLSearchParams(window.location.search);
      const latParam = parseFloat(urlParams.get('lat'));
      const lngParam = parseFloat(urlParams.get('lng'));

      const defaultCenter = { lat: -19.82, lng: -40.27 };
      const center = (!isNaN(latParam) && !isNaN(lngParam)) ? { lat: latParam, lng: lngParam } : defaultCenter;

      const map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom: 13,
        streetViewControl: false,
        mapTypeControl: false,
        styles: [
  {"elementType":"geometry","stylers":[{"color":"#212121"}]},
  {"elementType":"labels.icon","stylers":[{"visibility":"off"}]},
  {"elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},
  {"elementType":"labels.text.stroke","stylers":[{"color":"#212121"}]},
  {"featureType":"administrative","elementType":"geometry","stylers":[{"color":"#757575"}]},
  {"featureType":"administrative.country","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]},
  {"featureType":"administrative.locality","elementType":"labels.text.fill","stylers":[{"color":"#bdbdbd"}]},
  {"featureType":"poi","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},
  {"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#181818"}]},
  {"featureType":"poi.park","elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},
  {"featureType":"poi.park","elementType":"labels.text.stroke","stylers":[{"color":"#1b1b1b"}]},
  {"featureType":"road","elementType":"geometry.fill","stylers":[{"color":"#2c2c2c"}]},
  {"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#8a8a8a"}]},
  {"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#373737"}]},
  {"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#3c3c3c"}]},
  {"featureType":"road.highway.controlled_access","elementType":"geometry","stylers":[{"color":"#4e4e4e"}]},
  {"featureType":"road.local","elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},
  {"featureType":"transit","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},
  {"featureType":"water","elementType":"geometry","stylers":[{"color":"#000000"}]},
  {"featureType":"water","elementType":"labels.text.fill","stylers":[{"color":"#3d3d3d"}]}
]
      });

      const bairros = await fetchJson(RUAS_URL);

      bairros.forEach(b => {
        const coordsRaw = b.Poligono || '';
        if (!coordsRaw.includes(',')) return;

        const path = coordsRaw.split(';').map(pair => {
          const [lat, lng] = pair.split(',').map(Number);
          return { lat, lng };
        }).filter(p => !isNaN(p.lat) && !isNaN(p.lng));

        if (path.length < 3) return; // precisa de no mínimo 3 pontos

        const reputacao = parseFloat(b.ReputacaoComp || 0);
        const cor = getColorByReputacao(reputacao);

        const polygon = new google.maps.Polygon({
          paths: path,
          strokeColor: cor,
          strokeOpacity: 1,
          strokeWeight: 1.5,
          fillColor: cor,
          fillOpacity: 0.5,
          map
        });

        const resumo = (typeof b.Resumo_IA === 'string') ? b.Resumo_IA : '';
        const truncated = resumo.length > 200 ? resumo.slice(0, 200) + '...' : resumo;

        const infoContent = `
          <div class="info-window">
            <div class="badge" style="background:${cor};">Reputação: ${reputacao.toFixed(2)}</div>
            <div class="title">${b.Nome || 'Bairro sem nome'}</div>
            <div class="small">${truncated}</div>
            <div style="margin-top:6px;">
              <a href="#" onclick="openGlideDetail('${(b.DeepLink || '')}')">Ver no app</a>
            </div>
          </div>
        `;
        const infowindow = new google.maps.InfoWindow({ content: infoContent });

        polygon.addListener('click', (e) => {
          infowindow.setPosition(e.latLng);
          infowindow.open(map);
        });
      });
    }

    function openGlideDetail(linkOrFragment) {
      if (!linkOrFragment) {
        alert('Link da rua não disponível');
        return;
      }

      if (linkOrFragment.startsWith('http')) {
        window.location.href = linkOrFragment;
      } else {
        const base = 'https://vizinhancaviva.glide.page';
        const fullUrl = `${base}/${linkOrFragment}`;
        window.location.href = fullUrl;
      }
    }
  </script>
</body>
</html>
